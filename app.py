import streamlit as st
import os
import re
import platform
import pandas as pd
import matplotlib.pyplot as plt
from matplotlib import font_manager, rc
from dotenv import load_dotenv
import tempfile
import shutil

# LangChain ê´€ë ¨ ì„í¬íŠ¸
from langchain_core.prompts import PromptTemplate, ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from langchain_openai import ChatOpenAI, OpenAIEmbeddings
from langchain_community.document_loaders import PyPDFLoader
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain_chroma import Chroma

# --------------------------------------------------------------------------
# 1. ê¸°ë³¸ ì„¤ì • ë° ìœ í‹¸ë¦¬í‹°
# --------------------------------------------------------------------------
st.set_page_config(page_title="âš¡ ì „ë ¥ ë¶„ì„ AI 'ë¼ì˜¨'", layout="wide")
load_dotenv()

def init_font():
    """í•œê¸€ í°íŠ¸ ì„¤ì •"""
    system_name = platform.system()
    if system_name == 'Windows':
        rc('font', family='Malgun Gothic')
    elif system_name == 'Darwin':
        rc('font', family='AppleGothic')
    else:
        rc('font', family='NanumGothic')
    plt.rcParams['axes.unicode_minus'] = False

init_font()

# --------------------------------------------------------------------------
# 2. [í•µì‹¬] ì •ì  ì§€ì‹ ë° í”„ë¡¬í”„íŠ¸ (total.ipynb ë‚´ìš© ê·¸ëŒ€ë¡œ ì ìš©)
# --------------------------------------------------------------------------

# total.ipynbì˜ [ëª¨ë“ˆ 2] ë¬¸ì„œ ì „ë¬¸ê°€ì—ì„œ ì‚¬ìš©ëœ í”„ë¡¬í”„íŠ¸ ì›ë³¸
RAG_SYSTEM_PROMPT_TEMPLATE = """
# 1. ë‹¹ì‹ ì˜ ì—­í•  ë° í˜ë¥´ì†Œë‚˜
ë‹¹ì‹ ì€ ì „ë ¥ ìˆ˜ìš”, ì‹œê°„ì‹œê³„ì—´ ë¶„ì„, ê·¸ë¦¬ê³  ì „ë ¥ ê³„í†µ ìš´ì˜ ì›ì¹™ì— ëŠ¥ìˆ™í•œ ë°ì´í„° ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ì£¼ì–´ì§„ [ì •ì  ì§€ì‹ (EDA ê²°ê³¼)]ì™€ [ê²€ìƒ‰ëœ ìœ ì‚¬ ê³¼ê±° ì‚¬ë¡€ ë°ì´í„°]ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ëŒ€í•´ ì •í™•í•˜ê³  ë°ì´í„°ì— ê¸°ë°˜í•œ ë¶„ì„ì ì¸ ë‹µë³€ì„ ìƒì„±í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
ëª¨ë“  ì„¤ëª…ì€ í†µê³„ ë° ë°ì´í„° ë¶„ì„ì— ìµìˆ™í•˜ì§€ ì•Šì€ ì‚¬ìš©ì(ì¤‘í•™ìƒ ìˆ˜ì¤€)ë„ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ì¹œì ˆíˆ ì„¤ëª…í•©ë‹ˆë‹¤.

# 2. ì •ì  ì§€ì‹: ì „ë ¥ ìˆ˜ìš” EDA ë¶„ì„ ê²°ê³¼ (2019ë…„ 1ì›” ~ 2024ë…„ 10ì›”)
<ì „ë ¥ ìˆ˜ìš” EDA ë¶„ì„ ê²°ê³¼>
1. ë¶„ì„ ë°ì´í„° ê°œìš”
ë³¸ ë³´ê³ ì„œëŠ” 2019ë…„ 1ì›” 1ì¼ë¶€í„° 2024ë…„ 10ì›” 31ì¼ê¹Œì§€ì˜ êµ­ë‚´ ì‹œê°„ë³„ ì „ë ¥ ìˆ˜ìš”(power_demand_final.csv) ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì£¼ìš” íŒ¨í„´ì„ íƒìƒ‰ì ìœ¼ë¡œ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤.
ì‚¬ìš©ëœ ì£¼ìš” ë³€ìˆ˜ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
> ì „ë ¥ ìˆ˜ìš”(MW): ì¢…ì† ë³€ìˆ˜
> ê¸°ì˜¨(ta): ì „ë ¥ ìˆ˜ìš”ì— í° ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ë…ë¦½ ë³€ìˆ˜
> ìŠµë„(hm)
> ìš”ì¼(weekday)
> ê³„ì ˆ(spring, summer ë“±)
> íœ´ì¼ ì—¬ë¶€(is_holiday_dummies)
 
2. ì „ë ¥ ìˆ˜ìš”ì˜ ì „ì²´ ë¶„í¬
ì „ë ¥ ìˆ˜ìš”ì˜ ë¶„í¬ëŠ” ëŒ€ì²´ë¡œ í•œ ê°œì˜ ì¤‘ì‹¬ì„ ê°€ì§„ ë‹¨ë´‰í˜• ë¶„í¬ë¥¼ ë³´ì´ë©°, íŠ¹ì • êµ¬ê°„(ì•½ 55,000~70,000 MW)ì—ì„œ ìˆ˜ìš”ê°€ ì§‘ì¤‘ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì—¬ë¦„Â·ê²¨ìš¸ì˜ ëƒ‰ë‚œë°© ë¶€í•˜ ì¦ê°€ë¡œ ì¸í•´ ë†’ì€ ìˆ˜ìš”ê°€ ë°˜ë³µì ìœ¼ë¡œ ë°œìƒí•˜ëŠ” ê³„ì ˆì  íŠ¹ì„±ì„ ë°˜ì˜í•©ë‹ˆë‹¤.
 
3. ì£¼ìš” ë³€ìˆ˜ë³„ ì „ë ¥ ìˆ˜ìš” íŒ¨í„´
(1) ê¸°ì˜¨(ta)ê³¼ì˜ ê´€ê³„: ì „í˜•ì ì¸ Uìí˜• íŒ¨í„´
ê¸°ì˜¨ì€ ì „ë ¥ ìˆ˜ìš”ì— ê°€ì¥ í° ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ìš”ì¸ìœ¼ë¡œ, ë‹¤ìŒê³¼ ê°™ì€ ë¹„ì„ í˜•ì (Uìí˜•) ê´€ê³„ê°€ í™•ì¸ë©ë‹ˆë‹¤.
> 10~15Â°C ì´í•˜ì—ì„œëŠ” ê¸°ì˜¨ì´ ë‚®ì•„ì§ˆìˆ˜ë¡ ë‚œë°© ìˆ˜ìš” ì¦ê°€ â†’ ì „ë ¥ ìˆ˜ìš” ê¸‰ì¦
> 20~25Â°C ì´ìƒì—ì„œëŠ” ê¸°ì˜¨ì´ ë†’ì•„ì§ˆìˆ˜ë¡ ëƒ‰ë°© ìˆ˜ìš” ì¦ê°€ â†’ ì „ë ¥ ìˆ˜ìš” ê¸‰ì¦
> 15~20Â°C ì‚¬ì´ëŠ” ëƒ‰ë‚œë°© ë¶€í•˜ê°€ ê°€ì¥ ì‘ì€ êµ¬ê°„ìœ¼ë¡œ ì „ë ¥ ìˆ˜ìš”ê°€ ìµœì € ìˆ˜ì¤€ì„ ê¸°ë¡
ì¦‰, ê¸°ì˜¨ì´ â€œë„ˆë¬´ ë‚®ê±°ë‚˜ ë„ˆë¬´ ë†’ì„ ë•Œâ€ ì „ë ¥ ìˆ˜ìš”ëŠ” ëª¨ë‘ í¬ê²Œ ì¦ê°€í•©ë‹ˆë‹¤.

(2) ì‹œê°„ì  ìš”ì¸ì— ë”°ë¥¸ ì£¼ê¸°ì„±
ì „ë ¥ ìˆ˜ìš”ëŠ” ì—°ê°„Â·ê³„ì ˆÂ·ì›”Â·ì£¼Â·ì‹œê°„ ë‹¨ìœ„ì—ì„œ ë§¤ìš° ëšœë ·í•œ ì£¼ê¸°ì„±ì„ ë³´ì…ë‹ˆë‹¤.
-> ì—°ë„ë³„ ê²½í–¥
> 2019~2024ë…„ ë™ì•ˆ ì „ë ¥ ìˆ˜ìš”ëŠ” ì „ë°˜ì ìœ¼ë¡œ ì ì§„ì  ì¦ê°€ ì¶”ì„¸ë¥¼ ë³´ì„
> ì´ëŠ” ëƒ‰ë‚œë°© ê¸°ê°„ í™•ëŒ€ ë° ì „ë ¥ ì‚¬ìš© ì¦ê°€ ìš”ì¸ì´ ë³µí•©ì ìœ¼ë¡œ ì‘ìš©í•œ ê²ƒìœ¼ë¡œ í•´ì„ ê°€ëŠ¥
 
-> ê³„ì ˆë³„ íŒ¨í„´
> ì—¬ë¦„(7~8ì›”)ê³¼ ê²¨ìš¸(1~2ì›”): ëƒ‰ë‚œë°© ìˆ˜ìš”ë¡œ ì¸í•´ ìµœëŒ€ ì „ë ¥ ìˆ˜ìš” ë°œìƒ
> ë´„(4~5ì›”)ê³¼ ê°€ì„(9~10ì›”): ê°€ì¥ ë‚®ì€ ìˆ˜ìš” êµ¬ê°„
 
-> ìš”ì¼ë³„ íŒ¨í„´
> í‰ì¼(ì›”~ê¸ˆ): ì‚°ì—…Â·ìƒì—… í™œë™ ì¦ê°€ë¡œ ì „ë ¥ ìˆ˜ìš”ê°€ ê°€ì¥ ë†’ìŒ
> ì£¼ë§ ë° ê³µíœ´ì¼: ê³µì¥Â·ëŒ€í˜• ìƒì—…ì‹œì„¤ ìš´ì˜ ê°ì†Œë¡œ í‰ì¼ ëŒ€ë¹„ ìˆ˜ìš”ê°€ í¬ê²Œ ê°ì†Œ
> íŠ¹íˆ ê³µíœ´ì¼ì€ ì£¼ë§ë³´ë‹¤ ë” ë‚®ì€ ìˆ˜ì¤€ì˜ ìˆ˜ìš”ë¥¼ ë³´ì´ëŠ” ê²½í–¥ ìˆìŒ
 
-> ì‹œê°„ëŒ€ë³„ íŒ¨í„´
> ìƒˆë²½(2~5ì‹œ): ìµœì†Œ ìˆ˜ìš”
> ì˜¤ì „(6~9ì‹œ): ì¶œê·¼Â·í™œë™ ì¦ê°€ë¡œ ì²« ë²ˆì§¸ í”¼í¬
> ì •ì˜¤(12ì‹œ): ì¼ì‹œì  ì™„ë§Œí•œ ê°ì†Œ
> ì˜¤í›„(14~17ì‹œ): í•˜ë£¨ ì¤‘ ìµœëŒ€ í”¼í¬ í˜•ì„±
> ì´í›„ ì ì§„ì ìœ¼ë¡œ ê°ì†Œ

(3) íŠ¹ìˆ˜ì¼ íš¨ê³¼
ê³µíœ´ì¼(is_holiday_dummies=1)ì—ëŠ” ì‚°ì—…Â·ìƒì—…í™œë™ ê°ì†Œ, ì¶œê·¼ ì¸êµ¬ ê°ì†Œë¡œ ì¸í•´ ë¹„íœ´ì¼ ëŒ€ë¹„ ì „ë ¥ ìˆ˜ìš”ê°€ í˜„ì €íˆ ë‚®ê²Œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤. ë˜í•œ ê³µíœ´ì¼ íŒ¨í„´ì€ ì£¼ë§ê³¼ ìœ ì‚¬í•œ í•˜ë½ íŒ¨í„´ì„ ë³´ì…ë‹ˆë‹¤.

4. ê²°ë¡  ë° ì‹œì‚¬ì 
êµ­ë‚´ ì „ë ¥ ìˆ˜ìš”ëŠ” ë‹¤ìŒ ë„¤ ê°€ì§€ íŠ¹ì§•ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ëª…ë©ë‹ˆë‹¤.
> ê¸°ì˜¨ê³¼ì˜ ê°•í•œ ë¹„ì„ í˜• ê´€ê³„(Uìí˜•)
> ì—°Â·ê³„ì ˆÂ·ì›”Â·ì£¼Â·ì‹œê°„ ë“± ì—¬ëŸ¬ ë‹¨ìœ„ì—ì„œì˜ ëšœë ·í•œ ì£¼ê¸°ì„±
> í‰ì¼ ëŒ€ë¹„ ì£¼ë§Â·ê³µíœ´ì¼ì˜ ë‚®ì€ ìˆ˜ìš”(íŠ¹ìˆ˜ì¼ íš¨ê³¼)
> ì™„ë§Œí•œ ì¥ê¸° ì¦ê°€ ì¶”ì„¸
ì´ëŸ¬í•œ íŠ¹ì„±ì€ í–¥í›„ ì „ë ¥ ìˆ˜ìš” ì˜ˆì¸¡ ëª¨ë¸ë§ ì‹œ ì •í™•ë„ í–¥ìƒì— ì¤‘ìš”í•œ ê¸°ë°˜ì´ ë©ë‹ˆë‹¤.


# 3. í•µì‹¬ ê·œì¹™ ë° ê°€ì´ë“œë¼ì¸ (ìµœìš°ì„  ìˆœìœ„)
## 3.1. ë°ì´í„° ë° ë…¼ë¦¬ í†µì œ
> ë‹µë³€ì€ ì œê³µëœ ë°ì´í„°ì— ê¸°ë°˜í•œ ì •ë³´ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
> í†µê³„Â·ì‹œê³„ì—´ ê°œë…ì€ ë°˜ë“œì‹œ ì‰½ê²Œ ì„¤ëª…í•©ë‹ˆë‹¤.
> ì „ë¬¸ ìš©ì–´ëŠ” ì²˜ìŒ ë“±ì¥í•˜ë©´ ë°˜ë“œì‹œ ì •ì˜í•©ë‹ˆë‹¤.
> ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì˜ ì •í™•ì„±ì´ ë¶ˆí™•ì‹¤í•œ ê²½ìš° â€œì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•˜ë‹¤â€ê³  ëª…ì‹œí•©ë‹ˆë‹¤.
> ëª¨ë“  ìˆ˜ì¹˜ëŠ” ë‹¨ìœ„ë¥¼ ë°˜ë“œì‹œ ëª…ì‹œí•˜ë„ë¡ í•©ë‹ˆë‹¤. ë˜í•œ ì „ë ¥ ìˆ˜ìš”ì˜ ê¸°ë³¸ ë‹¨ìœ„ëŠ” MWì´ë©°, íŠ¹ë³„íˆ MWhë‚˜ kWhë¥¼ ì‚¬ìš©í•´ì•¼ í•  ê²½ìš° ê·¸ ì´ìœ ë¥¼ ëª…ì‹œí•©ë‹ˆë‹¤.
> ë‹µë³€ ì‹œ ë°ì´í„°ê°€ ì†í•œ ë‚ ì§œ, ì‹œê°„, ê³„ì ˆì„ ë°˜ë“œì‹œ ëª…ì‹œí•©ë‹ˆë‹¤.
> ìë£Œì—ì„œ ìˆ˜ìš” ë³€í™”ì˜ ì›ì¸(ì˜ˆ: ê¸°ì˜¨ ë³€í™”, ì •ì±…ì˜ ì˜í–¥, ì‚°ì—… í™œë™ ë“±)ì´ ì–¸ê¸‰ë˜ì–´ ìˆë‹¤ë©´, ìˆ˜ì¹˜ì™€ í•¨ê»˜ í•´ë‹¹ ì›ì¸ì„ ìš”ì•½í•˜ì—¬ ë‹µë³€ì— í¬í•¨í•©ë‹ˆë‹¤.
> ë‹µë³€ì˜ ê·¼ê±°ê°€ ëœ ë¬¸ì„œë¥¼ [ì¶œì²˜: ë¬¸ì„œëª… p.í˜ì´ì§€] í˜•ì‹ìœ¼ë¡œ ë¬¸ì¥ ëì— ë°˜ë“œì‹œ í¬í•¨í•©ë‹ˆë‹¤.
> ë°ì´í„°ì˜ ìš°ì„ ìˆœìœ„ëŠ” ë‹¤ìŒì„ ë”°ë¥´ì„¸ìš”.
1) SQL ì‹¤ì¸¡ ê°’
2) ì œê³µëœ ë¬¸ì„œ ë‚´ìš©
3) ê·¸ ì™¸ ìë£Œ
> ì´ìƒì¹˜ ì„¤ëª… ì‹œ ê¸°ì¤€ ê°’, ë³€í™”ìœ¨, ì¡°ê±´ì„ ë°˜ë“œì‹œ í¬í•¨í•©ë‹ˆë‹¤.
> ì‚¬ìš©ìì˜ ì§ˆë¬¸ì´ ì§€ì •ëœ ë°ì´í„° ë²”ìœ„ ë°–ì˜ ì •ë³´ë¥¼ ìš”êµ¬í•˜ê±°ë‚˜, ë°ì´í„°ë¡œ ê²€ì¦ ë¶ˆê°€ëŠ¥í•œ ì¶”ìƒì ì¸ ì›ì¸ ë¶„ì„ì„ ìš”êµ¬í•  ê²½ìš°, ë‹µë³€ì„ ì‹œì‘í•˜ê¸° ì „ì— â€œí˜„ì¬ ì œê³µëœ ë°ì´í„°(2019ë…„~2024ë…„ EDA ë° ì‹¤ì¸¡ ê°’)ë§Œìœ¼ë¡œëŠ” ì •í™•í•œ ë‹µë³€ì´ ë¶ˆê°€ëŠ¥í•˜ë©°, ì¶”ê°€ì ì¸ ìë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤.â€ë¼ê³  ëª…í™•í•˜ê²Œ ì„ ì„ ê¸‹ìŠµë‹ˆë‹¤.
> ì´ìƒì¹˜ë‚˜ íŠ¹ì • ë³€í™”ìœ¨ì„ ì„¤ëª…í•  ë•Œ, ë¹„êµ ê¸°ì¤€ì´ ë˜ëŠ” ê°’(ì˜ˆ: â€˜í‰ê·  ìˆ˜ìš”â€™)ì„ ëª…í™•íˆ ì œì‹œí•©ë‹ˆë‹¤. (ì˜ˆ: â€œí‰ê·  63,788 MW ëŒ€ë¹„ 15% ë†’ì€ ìˆ˜ì¤€ì…ë‹ˆë‹¤.â€)

## 3.2. ì„¤ëª… ë°©ì‹ ë° ìŠ¤íƒ€ì¼
> ì§ˆë¬¸ìì˜ ë°°ê²½ì§€ì‹ì„ ê³ ë ¤í•´ ì¤‘í•™ìƒ ìˆ˜ì¤€ìœ¼ë¡œ ì‰½ê²Œ ì„¤ëª…í•©ë‹ˆë‹¤.
> ì „ë¬¸ ìš©ì–´ë¥¼ ì‚¬ìš©í•˜ë˜, ì‚¬ìš© ì‹œ ë°˜ë“œì‹œ í’€ì–´ì„œ ì •ì˜í•©ë‹ˆë‹¤.
> ë‹¨ê³„ì  ì„¤ëª…ì„ ì œê³µí•˜ê³ , í•„ìš”ì‹œ ì˜ˆì‹œë¥¼ í†µí•´ ë³´ì¶©í•©ë‹ˆë‹¤.
> ë‹µë³€ ì‹œ ì œê³µëœ ë¬¸ì„œ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ë°˜ë³µí•˜ì§€ ì•Šê³ , ì‚¬ìš©ì ì§ˆë¬¸ì— ë§ê²Œ ì¬ê°€ê³µ ë° ìš”ì•½í•˜ì—¬ ë¶„ì„ ê²°ê³¼ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
> ê³¼ë„í•˜ê²Œ ì§§ê±°ë‚˜ ë‹¨ë‹µí˜•ì€ í”¼í•˜ê³ , ë§¥ë½ì„ ì´í•´í•  ìˆ˜ ìˆì„ ì •ë„ì˜ ì¶©ë¶„í•œ ê¸¸ì´ë¡œ ë‹µë³€í•©ë‹ˆë‹¤. 
> **ì„¤ëª… ìˆœì„œ:** ì •ì˜ â†’ ì›ë¦¬ â†’ ê³¼ì • â†’ í•´ì„ ìˆœìœ¼ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤.
> **ë³µí•© ë¶„ì„:** ì´ìƒì¹˜ë¥¼ ë¶„ì„í•  ë•ŒëŠ” ë‹¨ì¼ ë³€ìˆ˜ì—ë§Œ ì˜ì¡´í•˜ì§€ ì•Šê³ , **ì‹œê°„, ìš”ì¼, ê³„ì ˆ**ì˜ ì„¸ ê°€ì§€ ìš”ì†Œê°€ ê²°í•©í•˜ì—¬ ìˆ˜ìš”ë¥¼ ì¦í­ì‹œì¼°ìŒì„ ë°˜ë“œì‹œ ì„¤ëª…ì— í¬í•¨í•©ë‹ˆë‹¤.
> **ë‹µë³€ ìŠ¤íƒ€ì¼:** ì§ˆë¬¸ìì˜ ë°°ê²½ì§€ì‹ì„ ê³ ë ¤í•´ ì¤‘í•™ìƒ ìˆ˜ì¤€ìœ¼ë¡œ ì‰½ê²Œ ì„¤ëª…í•˜ë©°, ì¹œì ˆí•˜ê³  ì°¨ë¶„í•œ ë§íˆ¬ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.

# 4. ê¸ˆì§€ ê·œì¹™
> ì§ˆë¬¸ìì˜ ë°°ê²½ì§€ì‹ì„ ë¬´ì‹œí•˜ê³  ìˆ˜ì¤€ ë†’ì€ í‘œí˜„ ì‚¬ìš© ê¸ˆì§€í•©ë‹ˆë‹¤.
> ë¶ˆí•„ìš”í•œ ì „ë¬¸ ìš©ì–´ ë‚˜ì—´ì„ ê¸ˆì§€í•©ë‹ˆë‹¤.
> ë°ì´í„°(EDA, ê²€ìƒ‰ëœ ì‹¤ì¸¡ ê°’)ì—ì„œ ì§ì ‘ì ìœ¼ë¡œ í™•ì¸ë˜ì§€ ì•Šì€ ì •ì±…ì  íš¨ê³¼ë‚˜ ë¯¸ë˜ ì˜ˆì¸¡
ì— ëŒ€í•´ ë‹¨ì •ì ì¸ í‘œí˜„ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì¶”ë¡ ëœ ë‚´ìš©ì€ â€œë°ì´í„° ìƒì˜ ì¶”ë¡  ë”°ë¥´ë©´â€
ê³¼ ê°™ì´ ëª…ì‹œí•˜ì—¬ ê²¸ì†í•¨ì„ ìœ ì§€í•©ë‹ˆë‹¤.> ì§ˆë¬¸ê³¼ ë¬´ê´€í•œ ë‚´ìš© í™•ì¥ì„ ê¸ˆì§€í•©ë‹ˆë‹¤.
> í•´ì„ ì‹œ ê³¼ë„í•œ í™•ì‹  í‘œí˜„(â€œë°˜ë“œì‹œâ€, â€œ100%â€, â€œë¬´ì¡°ê±´â€ ë“±)ì€ ì‚¬ìš© ê¸ˆì§€í•©ë‹ˆë‹¤.
> íŠ¹ì • ìˆ˜ì¹˜ê°€ ì œê³µë˜ì§€ ì•Šì€ ê²½ìš°, ì„ì˜ë¡œ ë‹µë³€ ìƒì„±ì„ ê¸ˆì§€í•©ë‹ˆë‹¤.
> ì¶”ë¡ ëœ ë‚´ìš©ì´ ìˆë‹¤ë©´ â€œë°ì´í„° ìƒì˜ ì¶”ë¡ ì— ë”°ë¥´ë©´â€ê³¼ ê°™ì´ ëª…ì‹œí•˜ë©´ì„œ, ì´ ì¶”ë¡ ì´ â€˜ì œê³µëœ pdf ë¬¸ì„œ ë‚´ìš©â€™ì´ë‚˜ â€˜EDA ê²°ê³¼â€™ ì¤‘ ì–´ë–¤ ê²ƒì— ê¸°ë°˜í–ˆëŠ”ì§€ë„ ì¶”ê°€ì ìœ¼ë¡œ ëª…ì‹œí•˜ë„ë¡
í•©ë‹ˆë‹¤.

[ê´€ë ¨ ë¬¸ì„œ ë‚´ìš©]:
{context}

[ì§ˆë¬¸]:
{question}

[ì „ë¬¸ê°€ ë‹µë³€]:
"""

# --------------------------------------------------------------------------
# 3. ì—ì´ì „íŠ¸ í´ë˜ìŠ¤ ì •ì˜
# --------------------------------------------------------------------------

class DataAnalyst:
    def __init__(self, df):
        self.df = df
        # ê³„ì ˆ ì»¬ëŸ¼ ì „ì²˜ë¦¬
        if 'season' not in self.df.columns:
            self.df.rename(columns={'power demand(MW)': 'power', 'ta': 'temp', 'hm': 'humid'}, inplace=True)
            self.df['season'] = self.df.apply(self._get_season, axis=1)

    def _get_season(self, row):
        if row.get('spring') == 1: return 'ë´„'
        if row.get('summer') == 1: return 'ì—¬ë¦„'
        if row.get('autoum') == 1: return 'ê°€ì„'
        if row.get('winter') == 1: return 'ê²¨ìš¸'
        return 'ì•Œìˆ˜ì—†ìŒ'

    def solve(self, user_question):
        client = ChatOpenAI(model="gpt-4o", temperature=0)
        
        columns_info = """
        - date: datetime64 (YYYY-MM-DD HH:MM:SS)
        - power: float (ì „ë ¥ìˆ˜ìš”ëŸ‰, MW)
        - temp: float (ê¸°ì˜¨, Â°C)
        - humid: float (ìŠµë„, %)
        - season: string ('ë´„', 'ì—¬ë¦„', 'ê°€ì„', 'ê²¨ìš¸')
        """
        
        # Streamlitìš©ìœ¼ë¡œ plt.show() ëŒ€ì‹  fig ê°ì²´ ë°˜í™˜ ìœ ë„
        system_prompt = f"""
        ë„ˆëŠ” íŒŒì´ì¬ ë°ì´í„° ë¶„ì„ ì „ë¬¸ê°€ì•¼. ì£¼ì–´ì§„ `df`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ë‹µí•˜ëŠ” ì½”ë“œë¥¼ ì‘ì„±í•´.

        [ë°ì´í„° ì»¬ëŸ¼ ì •ë³´]
        {columns_info}

        [í•„ìˆ˜ ì‘ì„± ê·œì¹™]
        1. ì§ˆë¬¸ì„ í•´ê²°í•˜ëŠ” Python ì½”ë“œë¥¼ ì‘ì„±í•´.
        2. **ìµœì¢… ë‹µë³€ í…ìŠ¤íŠ¸ëŠ” ë°˜ë“œì‹œ `answer` ë³€ìˆ˜ì— ë¬¸ìì—´ë¡œ ì €ì¥í•´.** (print ê¸ˆì§€)
        3. **ê·¸ë˜í”„ê°€ í•„ìš”í•˜ë©´ `plt.figure()`ë¡œ ê·¸ë¦¼ì„ ê·¸ë¦¬ê³  `fig` ë³€ìˆ˜ì— ì €ì¥í•´.** (`plt.show()` ì‚¬ìš© ê¸ˆì§€)
        4. ì½”ë“œëŠ” ```python ... ``` ë¸”ë¡ ì•ˆì— ë‹´ì•„.
        5. ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° `if len(result) > 0:` ì²˜ë¦¬ë¥¼ í•´.
        6. ìˆ˜ì¹˜ëŠ” ì†Œìˆ˜ì  ì²«ì§¸ìë¦¬ê¹Œì§€, ì²œë‹¨ìœ„ ì½¤ë§ˆë¥¼ ì ìš©í•´.
        """

        response = client.invoke([
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_question}
        ]).content
        
        code_match = re.search(r"```python(.*?)```", response, re.DOTALL)
        if not code_match:
            return "ì½”ë“œ ìƒì„± ì‹¤íŒ¨", None
        
        generated_code = code_match.group(1).strip()
        
        # ì‹¤í–‰ í™˜ê²½ (ì „ì—­ ë³€ìˆ˜ ì£¼ì…)
        execution_env = {
            'df': self.df, 
            'pd': pd, 
            'plt': plt, 
            'answer': None,
            'fig': None
        }
        
        try:
            exec(generated_code, execution_env)
            return execution_env.get('answer', "ê²°ê³¼ í…ìŠ¤íŠ¸ ì—†ìŒ"), execution_env.get('fig')
        except Exception as e:
            return f"ì½”ë“œ ì‹¤í–‰ ì˜¤ë¥˜: {e}", None

class DocumentExpert:
    def __init__(self, vector_store):
        self.retriever = vector_store.as_retriever(search_kwargs={"k": 6})
        self.model = ChatOpenAI(model="gpt-4o-mini", temperature=0)
        
        # í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì„¤ì • (ì •ì  ì§€ì‹ í¬í•¨ëœ ë²„ì „)
        self.prompt = PromptTemplate(
            template=RAG_SYSTEM_PROMPT_TEMPLATE,
            input_variables=["context", "question"]
        )
        self.chain = self.prompt | self.model | StrOutputParser()

    def solve(self, user_question):
        # ë¬¸ì„œ ê²€ìƒ‰
        docs = self.retriever.invoke(user_question)
        context = "\n\n".join([f"[ì¶œì²˜: {d.metadata.get('source','ë¬¸ì„œ')} p.{d.metadata.get('page',0)+1}]\n{d.page_content}" for d in docs])
        
        # ë‹µë³€ ìƒì„±
        response = self.chain.invoke({"context": context, "question": user_question})
        return response

class PowerAgent:
    def __init__(self, df, vector_store):
        self.analyst = DataAnalyst(df)
        self.expert = DocumentExpert(vector_store)
        self.router = ChatOpenAI(model="gpt-4o-mini", temperature=0)

    def ask(self, question):
        # ì˜ë„ ë¶„ë¥˜
        intent = self.router.invoke(f"""
        ì§ˆë¬¸ì´ 'ë°ì´í„° ìˆ˜ì¹˜ ê³„ì‚°/ì‹œê°í™”'(data)ì¸ì§€ 'ë¬¸ì„œ ê¸°ë°˜ ì§€ì‹/ì´ìœ /ì •ì±… ì„¤ëª…'(doc)ì¸ì§€ ë¶„ë¥˜í•´.
        ì§ˆë¬¸: {question}
        ì‘ë‹µì€ ì˜¤ì§ 'data' ë˜ëŠ” 'doc' ë§Œ ì¶œë ¥í•´.
        """).content.strip().lower()
        
        if "data" in intent:
            return "DATA", self.analyst.solve(question)
        else:
            # ë¬¸ì„œ ë‹µë³€ì€ textë§Œ ë°˜í™˜ë˜ë¯€ë¡œ figëŠ” None ì²˜ë¦¬
            return "DOC", (self.expert.solve(question), None)

# --------------------------------------------------------------------------
# 4. ë°ì´í„° ë¡œë” í•¨ìˆ˜ (ìºì‹± ì ìš©)
# --------------------------------------------------------------------------
@st.cache_resource
def load_csv_data(file):
    df = pd.read_csv(file)
    df['date'] = pd.to_datetime(df['date'])
    return df

@st.cache_resource
def create_vector_db(_files):
    embeddings = OpenAIEmbeddings(model="text-embedding-3-small")
    temp_dir = tempfile.mkdtemp()
    docs = []
    
    for file in _files:
        temp_path = os.path.join(temp_dir, file.name)
        with open(temp_path, "wb") as f:
            f.write(file.getvalue())
            
        loader = PyPDFLoader(temp_path)
        pages = loader.load()
        for doc in pages:
            doc.metadata["source"] = file.name
            docs.append(doc)
    
    splitter = RecursiveCharacterTextSplitter(chunk_size=1000, chunk_overlap=200)
    splits = splitter.split_documents(docs)
    
    # ë©”ëª¨ë¦¬ ìƒì˜ Chroma DB ìƒì„±
    vector_store = Chroma.from_documents(documents=splits, embedding=embeddings)
    
    # ì„ì‹œ íŒŒì¼ ì •ë¦¬
    shutil.rmtree(temp_dir)
    return vector_store

# --------------------------------------------------------------------------
# 5. Streamlit UI
# --------------------------------------------------------------------------

st.title("âš¡ ì „ë ¥ ë¶„ì„ AI 'ë¼ì˜¨'")
st.markdown("### ì •ì  ì§€ì‹(EDA ê²°ê³¼)ê³¼ ë™ì  ë°ì´í„° ë¶„ì„ì´ ê²°í•©ëœ ì „ë¬¸ê°€ AIì…ë‹ˆë‹¤.")

with st.sidebar:
    st.header("ğŸ“‚ ë°ì´í„° ì„¤ì •")
    
    api_key = st.text_input("OpenAI API Key", type="password")
    if api_key:
        os.environ["OPENAI_API_KEY"] = api_key
    
    uploaded_csv = st.file_uploader("ì „ë ¥ ë°ì´í„° (CSV)", type=["csv"])
    uploaded_pdfs = st.file_uploader("ì°¸ê³  ë¬¸ì„œ (PDF)", type=["pdf"], accept_multiple_files=True)
    
    if st.button("ğŸ”„ ì—ì´ì „íŠ¸ ì´ˆê¸°í™”"):
        st.cache_resource.clear()
        st.rerun()

if "messages" not in st.session_state:
    st.session_state.messages = [{"role": "assistant", "content": "ì•ˆë…•í•˜ì„¸ìš”! ì „ë ¥ ìˆ˜ìš” ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?"}]

for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.write(msg["content"])
        if "image" in msg and msg["image"] is not None:
            st.pyplot(msg["image"])

if prompt := st.chat_input("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."):
    if not os.environ.get("OPENAI_API_KEY"):
        st.error("API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
        st.stop()
        
    if not uploaded_csv or not uploaded_pdfs:
        st.warning("ë°ì´í„° íŒŒì¼(CSV, PDF)ì„ ëª¨ë‘ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
        st.stop()

    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.write(prompt)

    # ì—ì´ì „íŠ¸ ìƒì„± (ìºì‹±ëœ ë°ì´í„° ì‚¬ìš©)
    with st.spinner("ë°ì´í„° ì²˜ë¦¬ ì¤‘..."):
        df = load_csv_data(uploaded_csv)
        vector_store = create_vector_db(uploaded_pdfs)
        agent = PowerAgent(df, vector_store)

    # ë‹µë³€ ìƒì„±
    with st.chat_message("assistant"):
        with st.spinner("ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."):
            try:
                mode, (text_response, fig) = agent.ask(prompt)
                
                if mode == "DATA":
                    st.caption("ğŸ“Š ë°ì´í„° ë¶„ì„ ëª¨ë“œ")
                else:
                    st.caption("ğŸ“š ë¬¸ì„œ/ì§€ì‹ ê²€ìƒ‰ ëª¨ë“œ")
                
                st.write(text_response)
                
                if fig:
                    st.pyplot(fig)
                    st.session_state.messages.append({"role": "assistant", "content": text_response, "image": fig})
                else:
                    st.session_state.messages.append({"role": "assistant", "content": text_response, "image": None})
                    
            except Exception as e:
                st.error(f"ì˜¤ë¥˜ ë°œìƒ: {e}")
                